{{/* Hugo Blox: People */}}
{{/* Documentation: https://hugoblox.com/blocks/ */}}
{{/* License: https://github.com/HugoBlox/hugo-blox-builder/blob/main/LICENSE.md */}}

{{/* Initialise */}}
{{ $page := .wcPage }}
{{ $block := .wcBlock }}
{{ $show_social := $block.design.show_social | default false }}
{{ $show_interests := $block.design.show_interests | default true }}
{{ $show_organizations := $block.design.show_organizations | default false }}
{{ $show_role := $block.design.show_role | default true }}

<section class="people-section py-12">
  <div class="max-w-3xl mx-auto">
    <div class="people-widget">
      {{ with $block.content.title }}
        <div class="w-full mb-8 text-center">
          <h1 class="mb-0 text-4xl font-bold text-gray-900 dark:text-white">{{ . | markdownify | emojify }}</h1>
          {{ with $block.content.subtitle }}<p class="mt-2 text-lg text-gray-600 dark:text-gray-400">{{ . | markdownify | emojify }}</p>{{ end }}
        </div>
      {{ end }}

      {{ with $block.content.text }}
        <div class="w-full mb-8">
          <div class="prose prose-lg max-w-none text-gray-700 dark:text-gray-300 text-center">
            {{ . | emojify | $page.RenderString }}
          </div>
        </div>
      {{ end }}

      {{ range $block.content.user_groups }}
        {{ $query := where (where site.Pages "Section" "authors") ".Params.user_groups" "intersect" (slice .) }}

        {{/* Sort with get_sort_by_parameter function */}}
        {{ $sort_by := $block.content.sort_by | default "last_name" }}
        {{ $sort_by = partial "functions/get_sort_by_parameter" $sort_by }}
        {{ $sort_ascending := $block.content.sort_ascending | default true }}
        {{ $sort_order := cond $sort_ascending "asc" "desc" }}
        {{ $query = sort $query $sort_by $sort_order }}

        {{if $query | and (gt (len $block.content.user_groups) 1) }}
          <div class="w-full mb-6">
            <h2 class="text-2xl font-semibold text-gray-900 dark:text-white text-center">{{ . | markdownify }}</h2>
          </div>
        {{end}}

        {{/* Flexible centered layout for single or multiple people */}}
        <div class="flex flex-wrap justify-center gap-6 mb-12">
          {{ range $query }}
            {{ $avatar := (.Resources.ByType "image").GetMatch "*avatar*" }}
            
            {{/* Simple direct author link generation */}}
            {{ $author_username := "" }}
            {{ if .File }}
              {{ $author_username = path.Base .File.Dir }}
            {{ else }}
              {{ $author_username = .Title | urlize }}
            {{ end }}
            
            {{/* Create direct author link */}}
            {{ $author_link := printf "/authors/%s/" $author_username }}
            
            {{/* Person card with separate clickable elements */}}
            <div class="people-person flex flex-col items-center p-6 bg-white dark:bg-gray-800 rounded-lg shadow-sm hover:shadow-lg transition-all duration-300 max-w-xs group">
              
              {{/* Clickable Avatar Image */}}
              {{ $src := "" }}
              {{ if site.Params.features.avatar.gravatar }}
                {{ $src = printf "https://s.gravatar.com/avatar/%s?s=200" (md5 .Params.email) }}
              {{ else if $avatar }}
                {{ $avatar_image := $avatar.Fill "200x200 Center" }}
                {{ $src = $avatar_image.RelPermalink }}
              {{ end }}
              
              {{ if $src }}
                {{ $avatar_shape := site.Params.features.avatar.shape | default "circle" }}
                <a href="{{ $author_link }}" class="block mb-4 transition-transform duration-300 hover:scale-110">
                  <img width="200" height="200" loading="lazy" 
                       class="avatar w-32 h-32 object-cover mx-auto {{if eq $avatar_shape "square"}}rounded-lg{{else}}rounded-full{{end}} border-4 border-transparent hover:border-primary-200 dark:hover:border-primary-800 transition-all duration-300" 
                       src="{{ $src }}" alt="{{ .Title }} Avatar">
                </a>
              {{ else }}
                {{/* Fallback clickable avatar */}}
                <a href="{{ $author_link }}" class="block mb-4 transition-transform duration-300 hover:scale-110">
                  <div class="avatar w-32 h-32 mx-auto rounded-full bg-gray-200 dark:bg-gray-600 flex items-center justify-center border-4 border-transparent hover:border-primary-200 dark:hover:border-primary-800 transition-all duration-300">
                    <svg class="w-16 h-16 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
                    </svg>
                  </div>
                </a>
              {{ end }}

              {{/* Portrait Title and Details */}}
              <div class="portrait-title text-center w-full">
                {{/* Clickable Title */}}
                <h3 class="text-xl font-semibold mb-2 transition-colors duration-200" 
                    style="font-size: 1.25rem !important; line-height: 1.75rem !important;">
                  <a href="{{ $author_link }}" class="text-gray-900 dark:text-white hover:text-primary-600 dark:hover:text-primary-400 no-underline">
                    {{ .Title }}
                  </a>
                </h3>
                
                {{ if and $show_organizations .Params.organizations }}
                  {{ range .Params.organizations }}
                    <p class="text-lg font-medium text-gray-600 dark:text-gray-400 mb-1">{{ .name }}</p>
                  {{ end }}
                {{ end }}
                
                {{ if and $show_role .Params.role }}
                  <p class="text-lg text-gray-600 dark:text-gray-400 mb-3">{{ .Params.role | markdownify | emojify }}</p>
                {{ end }}
                
                {{ if and $show_interests .Params.interests }}
                  <p class="people-interests text-sm text-gray-500 dark:text-gray-500">
                    {{ delimit .Params.interests ", " | markdownify | emojify }}
                  </p>
                {{ end }}
              </div>
              
              {{/* Social links */}}
              {{ if $show_social }}
                <div class="flex justify-center space-x-2 mt-3 text-lg">
                  {{ partial "social_links" . }}
                </div>
              {{ end }}
            </div>
          {{ end }}
        </div>
      {{ end }}
    </div>
  </div>
</section>
